"use strict";(self.webpackChunkcurator_site=self.webpackChunkcurator_site||[]).push([[3163],{4955:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>t,toc:()=>i});const t=JSON.parse('{"id":"async-details","title":"Curator Async Usage","description":"With this DSL you can do asynchronous tasks in a more natural, functional way using Java 8 lambdas. For example:","source":"@site/docs/async-details.md","sourceDirName":".","slug":"/async-details","permalink":"/docs/async-details","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/curator-site/tree/main/docs/async-details.md","tags":[],"version":"current","lastUpdatedBy":"tison","lastUpdatedAt":1740888071000,"frontMatter":{"displayed_sidebar":"docs"},"sidebar":"docs"}');var s=a(5105),c=a(6413);const o={displayed_sidebar:"docs"},r="Curator Async Usage",l={},i=[{value:"Usage",id:"usage",level:2},{value:"AsyncStage",id:"asyncstage",level:3},{value:"Watchers",id:"watchers",level:3},{value:"AsyncEventException",id:"asynceventexception",level:3},{value:"AsyncResult",id:"asyncresult",level:3},{value:"Examples",id:"examples",level:2},{value:"Create a sequential ZNode",id:"create-a-sequential-znode",level:3},{value:"AsyncStage canonical usage",id:"asyncstage-canonical-usage",level:3},{value:"Simplified usage via AsyncResult",id:"simplified-usage-via-asyncresult",level:3},{value:"Using executors",id:"using-executors",level:3},{value:"Separate handlers",id:"separate-handlers",level:3},{value:"Synchronous usage",id:"synchronous-usage",level:3}];function h(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"curator-async-usage",children:"Curator Async Usage"})}),"\n",(0,s.jsxs)(n.p,{children:["With this DSL you can do asynchronous tasks in a more natural, functional way using ",(0,s.jsx)(n.a,{href:"https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html",children:"Java 8 lambdas"}),". For example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'// let "client" be a CuratorFramework instance\nAsyncCuratorFramework async = AsyncCuratorFramework.wrap(client);\nasync.checkExists().forPath(somePath).thenAccept(stat -> mySuccessOperation(stat));\n'})}),"\n",(0,s.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsx)(n.p,{children:"To use Curator Async, you should be familiar with Java 8's lambdas, CompletedFuture and CompletionStage."})}),"\n",(0,s.jsxs)(n.p,{children:["Create a ",(0,s.jsx)(n.a,{href:"/docs/framework",children:"CuratorFramework"})," instance in the normal way. You then wrap this instance using AsyncCuratorFramework. i.e.,"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'// let "client" be a CuratorFramework instance\nAsyncCuratorFramework async = AsyncCuratorFramework.wrap(client);\n'})}),"\n",(0,s.jsx)(n.p,{children:"AsyncCuratorFramework has most of the same builder methods that CuratorFramework does with some important differences:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"AsyncCuratorFramework builders return AsyncStage instances"}),"\n",(0,s.jsx)(n.li,{children:"AsyncCuratorFramework builders have no checked exceptions"}),"\n",(0,s.jsx)(n.li,{children:"Many of the builder methods have been simplified/clarified"}),"\n",(0,s.jsx)(n.li,{children:"All builders invoke the asynchronous versions of ZooKeeper APIs"}),"\n",(0,s.jsx)(n.li,{children:"Watchers also use CompletionStages - see below for details"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"asyncstage",children:"AsyncStage"}),"\n",(0,s.jsx)(n.p,{children:'AsyncStage instances extend Java 8\'s CompletionStage. CompletionStage objects can be "completed" with a success value or an exception. The parameterized type of the AsyncStage will be whatever the builder used would naturally return as a success value. E.g. the async getData() builder\'s AsyncStage is parameterized with "byte[]".'}),"\n",(0,s.jsx)(n.h3,{id:"watchers",children:"Watchers"}),"\n",(0,s.jsx)(n.p,{children:"ZooKeeper's watchers also get the CompletionStage treatment in Curator Async. To add a watcher, call watched() prior to starting the appropriate builders. E.g.,"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"async.watched().getData().forPath(path) ...\n"})}),"\n",(0,s.jsx)(n.p,{children:"Thus, a data watcher will be set on the specified path. You access the CompletionStage for the watcher by using the event() method of AsyncStage. Here is a complete example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"async.watched().getData().forPath(path).event().thenAccept(watchedEvent -> watchWasTriggered(watchedEvent));\n"})}),"\n",(0,s.jsx)(n.p,{children:"ZooKeeper calls watchers when there is a connection loss. This can make using the CompletionStage somewhat complicated (see AsyncEventException below). If you are not interested in watcher connection problems, you can tell Curator Async to not send them by calling:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"// only complete the CompletionStage when the watcher is successfully triggered\n// i.e. don't complete on connection issues\nasync.with(WatchMode.successOnly).watched()...\n"})}),"\n",(0,s.jsx)(n.h3,{id:"asynceventexception",children:"AsyncEventException"}),"\n",(0,s.jsxs)(n.p,{children:["When an async watcher fails the exception set in the CompletionStage will be of type ",(0,s.jsx)(n.code,{children:"AsyncEventException"}),". This exception allows you to see the KeeperState that caused the trigger and allows you to reset the completion stage. Reset is needed because ZooKeeper temporarily triggers watchers when there is a connection event (unless ",(0,s.jsx)(n.code,{children:"WatchMode.successOnly"})," is used). However, the watcher stays set for the original operation. Use ",(0,s.jsx)(n.code,{children:"AsyncEventException#reset"})," to start a new completion stage that will wait on the next trigger of the watcher."]}),"\n",(0,s.jsx)(n.p,{children:"E.g.,"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"AsyncStage stage = ...\nstage.event().exceptionally(e -> {\n    AsyncEventException asyncEx = (AsyncEventException) e;\n\n    // ... note a connection problem ...\n\n    asyncEx.reset().thenAccept(watchedEvent -> watchWasTriggered(watchedEvent));\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"asyncresult",children:"AsyncResult"}),"\n",(0,s.jsxs)(n.p,{children:["As a convenience, you can use ",(0,s.jsx)(n.code,{children:"AsyncResult"})," to combine ZooKeeper method value, the ZooKeeper result code and any exception in one object allowing you to not worry about exceptional completions. i.e. the ",(0,s.jsx)(n.code,{children:"CompletionStage"})," returned by ",(0,s.jsx)(n.code,{children:"AsyncResult.of()"})," always completes successfully with an AsyncResult object."]}),"\n",(0,s.jsx)(n.p,{children:"AsyncResult has methods to get either the method result (a path, Stat, etc.), a KeeperException code or a general exception:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"Optional<T> getValue();\nKeeperException.Code getCode();\nOptional<Throwable> getException();\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Use AsyncResult by wrapping an ",(0,s.jsx)(n.code,{children:"AsyncStage"})," value. i.e.,"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"CompletionStage<AsyncResult<Stat>> resultStage = AsyncResult.of(async.checkExists().forPath(path));\nresultStage.thenAccept(result -> {\n    if ( result.getValue().isPresent() ) {\n        // ...\n    } else if ( result.getCode() == KeeperException.Code.NOAUTH ) {\n        // ...\n    }\n    // etc.\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,s.jsx)(n.h3,{id:"create-a-sequential-znode",children:"Create a sequential ZNode"}),"\n",(0,s.jsx)(n.p,{children:"Create a sequential ZNode and, once successfully completed, set a watcher on the ZNode."}),"\n",(0,s.jsx)(n.admonition,{type:"caution",children:(0,s.jsx)(n.p,{children:"This code does not deal with errors. Should a connection problem occur or another exception occur, the completion lambda will never be called."})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"async.create()\n    .withMode(PERSISTENT_SEQUENTIAL)\n    .forPath(path)\n    .thenCompose(actualPath -> async.watched()\n                                .getData()\n                                .forPath(actualPath)\n                                .thenApply(() -> watchTriggered()));\n"})}),"\n",(0,s.jsx)(n.h3,{id:"asyncstage-canonical-usage",children:"AsyncStage canonical usage"}),"\n",(0,s.jsxs)(n.p,{children:["This is the canonical way to deal with AsyncStage. Use the ",(0,s.jsx)(n.code,{children:"handle()"})," method which provides both the success value and the exception. The exception will be non-null on error."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"async.create().withOptions(EnumSet.of(doProtected)).forPath(path).handle((actualPath, exception) -> {\n    if (exception != null) {\n        // handle problem\n    } else {\n        // actualPath is the path created\n    }\n    return null;\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"simplified-usage-via-asyncresult",children:"Simplified usage via AsyncResult"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"AsyncResult.of(async.create().withOptions(EnumSet.of(doProtected)).forPath(path)).thenAccept(result -> {\n    if (result.getRawValue() != null) {\n        // result.getRawValue() is the path created\n    } else {\n        // ...\n    }\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"using-executors",children:"Using executors"}),"\n",(0,s.jsx)(n.p,{children:"Your completion routines can operate in a separate thread if you provide an executor."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'async.create()\n    .withOptions(EnumSet.of(createParentsIfNeeded))\n    .forPath("/a/b/c")\n    .thenAcceptAsync(path -> handleCreate(path), executor);\n'})}),"\n",(0,s.jsx)(n.h3,{id:"separate-handlers",children:"Separate handlers"}),"\n",(0,s.jsx)(n.p,{children:"This example shows specifying separate completion handlers for success and exception."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'AsyncStage<byte[]> stage = async.getData().forPath("/my/path");\nstage.exceptionally(e -> {\n    if (e instanceof KeeperException.NoNodeException) {\n        // handle no node\n    } else {\n        // handle other\n    }\n    return null;\n});\nstage.thenAccept(data -> processData(data));\n'})}),"\n",(0,s.jsx)(n.h3,{id:"synchronous-usage",children:"Synchronous usage"}),"\n",(0,s.jsx)(n.p,{children:"CompletionStage provides a blocking method as well so that you can block to get the result of an operation. i.e. this makes it possible to use the async APIs in a synchronous way."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:'// NOTE: get() specifies a checked exception\nasync.create().forPath("/foo").toCompletableFuture().get();\n'})})]})}function d(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},6413:(e,n,a)=>{a.d(n,{R:()=>o,x:()=>r});var t=a(8101);const s={},c=t.createContext(s);function o(e){const n=t.useContext(c);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(c.Provider,{value:n},e.children)}}}]);