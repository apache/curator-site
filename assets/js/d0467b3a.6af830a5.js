"use strict";(self.webpackChunkcurator_site=self.webpackChunkcurator_site||[]).push([[2682],{2739:(e,a,n)=>{n.r(a),n.d(a,{assets:()=>l,contentTitle:()=>s,default:()=>p,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"migrations","title":"Migrations","description":"Curator Migrations allow you pre-apply transactions in a staged manner so that you can ensure a consistent state for parts of your ZooKeeper node hierarchy in a manner similar to database migration utilities.","source":"@site/docs/migrations.md","sourceDirName":".","slug":"/migrations","permalink":"/docs/migrations","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/curator-site/tree/main/docs/migrations.md","tags":[],"version":"current","lastUpdatedBy":"tison","lastUpdatedAt":1740614244000,"frontMatter":{},"sidebar":"docs","previous":{"title":"Strongly Typed Models","permalink":"/docs/modeled"},"next":{"title":"Schema Support","permalink":"/docs/schema"}}');var i=n(5105),o=n(6413);const r={},s="Migrations",l={},c=[{value:"Background and Usage",id:"background-and-usage",level:2},{value:"Details/Reference",id:"detailsreference",level:2},{value:"Migration",id:"migration",level:3},{value:"MigrationSet",id:"migrationset",level:3},{value:"MigrationManager",id:"migrationmanager",level:3}];function d(e){const a={admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(a.header,{children:(0,i.jsx)(a.h1,{id:"migrations",children:"Migrations"})}),"\n",(0,i.jsx)(a.p,{children:"Curator Migrations allow you pre-apply transactions in a staged manner so that you can ensure a consistent state for parts of your ZooKeeper node hierarchy in a manner similar to database migration utilities."}),"\n",(0,i.jsx)(a.h2,{id:"background-and-usage",children:"Background and Usage"}),"\n",(0,i.jsx)(a.admonition,{type:"note",children:(0,i.jsx)(a.p,{children:"To use Migrations, you should be familiar with Java 8's lambdas, CompletedFuture and CompletionStage."})}),"\n",(0,i.jsx)(a.p,{children:'A "migration" is a set of operations to be performed in a transaction. A "migration set" is a list of migrations. Combined, this can be used to ensure an initial state for your ZooKeeper nodes as well as supporting upgrading/modifying existing state.'}),"\n",(0,i.jsx)(a.p,{children:"For example, given a brand-new ZooKeeper instance you might want to populate a few nodes and data. E.g.,"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:'CuratorOp op1 = client.transactionOp().create().forPath("/parent");\nCuratorOp op2 = client.transactionOp().create().forPath("/parent/one");\nCuratorOp op3 = client.transactionOp().create().forPath("/parent/two");\nCuratorOp op4 = client.transactionOp().create().forPath("/parent/three");\nCuratorOp op5 = client.transactionOp().create().forPath("/main", someData);\n'})}),"\n",(0,i.jsx)(a.p,{children:"All five of these operations would be combined into a migration and set:"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:'Migration migration = () -> Arrays.asList(op1, op2, op3, op4, op5);\nMigrationSet set = MigrationSet.build("main", Collections.singletonList(migration));\n'})}),"\n",(0,i.jsxs)(a.p,{children:["This set can then be passed to a ",(0,i.jsx)(a.code,{children:"MigrationManager"})," for processing. The MigrationManager checks to see if the migration has been applied already and, if not, processes the transaction."]}),"\n",(0,i.jsx)(a.p,{children:"At a future date, the migration set could be expanded to update/modify things. E.g.,"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:'CuratorOp newOp1 = client.transactionOp().create().forPath("/new");\nCuratorOp newOp2 = client.transactionOp().delete().forPath("/main");    // maybe this is no longer needed\n'})}),"\n",(0,i.jsx)(a.p,{children:"This would be combined with the previous migration:"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:'Migration initialMigration = () -> Arrays.asList(op1, op2, op3, op4, op5);\nMigration newMigration = () -> Arrays.asList(newOp1, newOp2);\nMigrationSet set = MigrationSet.build("main", Arrays.asList(initialMigration, newMigration));\n'})}),"\n",(0,i.jsx)(a.p,{children:'When this set is run, the MigrationManager will perform both migration operations on new ZooKeeper databases but only the second "newMigration" on ZK databases that already have the first migration applied.'}),"\n",(0,i.jsx)(a.h2,{id:"detailsreference",children:"Details/Reference"}),"\n",(0,i.jsx)(a.h3,{id:"migration",children:"Migration"}),"\n",(0,i.jsx)(a.p,{children:"A Migration is a wrapper around a list of operations that constitute one stage in a migration set and are applied as a single transaction."}),"\n",(0,i.jsx)(a.h3,{id:"migrationset",children:"MigrationSet"}),"\n",(0,i.jsx)(a.p,{children:"A MigrationSet is an ordered list of Migrations. Curator keeps track of which migrations in a set have been previously applied and only processes un-applied migrations. Each migration set must have a unique identifier. Create a MigrationSet via its builder:"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:"MigrationSet set = MigrationSet.build(migrationId, migrations);\n"})}),"\n",(0,i.jsx)(a.h3,{id:"migrationmanager",children:"MigrationManager"}),"\n",(0,i.jsx)(a.p,{children:"The MigrationManager processes MigrationSets. Usually, you'd run this only on new ZooKeeper databases or as part of a maintenance operation to update the ZooKeeper database. E.g.,"}),"\n",(0,i.jsx)(a.pre,{children:(0,i.jsx)(a.code,{className:"language-java",children:"MigrationManager manager = new MigrationManager(\n    client,\n    lockPath,       // base path for locks used by the manager\n    metaDataPath,   // base path to store the meta data\n    executor,       // the executor to use\n    lockMax         // max time to wait for locks\n);\nmanager.migrate(set).exceptionally(e -> {\n    if (e instanceof MigrationException) {\n        // migration checksum failed, etc.\n    } else {\n        // some other kind of error\n    }\n    return null;\n});\n"})}),"\n",(0,i.jsxs)(a.ul,{children:["\n",(0,i.jsx)(a.li,{children:"Each migration in the set is applied in a single transaction i.e. all operations that comprise a migration set (the sum of all individual migration operations) are sent to ZooKeeper as a single transaction."}),"\n",(0,i.jsxs)(a.li,{children:["MigrationManager stores a hash of all operations in a migration so that it can be compared for future operations. i.e. if, in the future, a migration set is attempted but the hash of one of the previous migrations does not match, the stage completes exceptionally with ",(0,i.jsx)(a.code,{children:"MigrationException"}),"."]}),"\n"]})]})}function p(e={}){const{wrapper:a}={...(0,o.R)(),...e.components};return a?(0,i.jsx)(a,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},6413:(e,a,n)=>{n.d(a,{R:()=>r,x:()=>s});var t=n(8101);const i={},o=t.createContext(i);function r(e){const a=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function s(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:a},e.children)}}}]);